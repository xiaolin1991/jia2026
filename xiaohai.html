<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>晓林技术支持设计开发——坐姿监控助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #5d6afb;
            --primary-dark: #4a56d2;
            --secondary: #ff7b9c;
            --success: #4cd964;
            --warning: #ffcc00;
            --danger: #ff6b6b;
            --light: #f9f9ff;
            --dark: #333366;
            --text: #444;
            --border: #e0e4ff;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f0f3ff 0%, #e8edff 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(93, 106, 251, 0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .video-container {
            width: 100%;
            height: 300px;
            background: #111;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            border: 3px solid var(--primary);
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .status-dot.warning {
            background: var(--warning);
        }
        
        .status-dot.danger {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .control-panel {
            background: #f9f9ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(90deg, var(--success) 0%, #3ac752 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, var(--danger) 0%, #e05555 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(90deg, var(--warning) 0%, #e6b800 100%);
            color: #333;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .alert-box {
            background: linear-gradient(90deg, #fff9e6 0%, #fff0cc 100%);
            border-left: 4px solid var(--warning);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .alert-box.show {
            display: flex;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .alert-icon {
            font-size: 1.8rem;
            color: var(--warning);
        }
        
        .timer-container {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6ebff 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .timer-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-dark);
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(93, 106, 251, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            width: 0%;
            transition: width 1s linear;
        }
        
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tip-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .tip-card h4 {
            color: var(--primary-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-history {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .warning-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .warning-item:last-child {
            border-bottom: none;
        }
        
        .warning-item i {
            color: var(--danger);
            margin-top: 2px;
        }
        
        .compatibility-fix {
            background: #fff8e1;
            border-left: 4px solid #ffb300;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .compatibility-fix.show {
            display: block;
        }
        
        .fix-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .video-container {
                height: 250px;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                font-size: 2rem;
            }
            
            .tips-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <i class="fas fa-child"></i>
                学习坐姿监控助手—晓林技术支持
            </h1>
            <p>智能检测坐姿，培养良好习惯，保护视力健康,专门监督曹无奈</p>
        </header>
        
        <div class="main-content">
            <!-- 兼容性修复提示 -->
            <div class="compatibility-fix" id="compatibility-fix">
                <h3 class="section-title"><i class="fas fa-tools"></i> 华为浏览器兼容性修复</h3>
                <p>检测到华为浏览器语音功能受限，请尝试以下方案：</p>
                <div class="fix-options">
                    <button class="btn btn-primary" id="fix-audio-context">
                        <i class="fas fa-volume-up"></i> 修复音频播放
                    </button>
                    <button class="btn btn-success" id="enable-autoplay">
                        <i class="fas fa-play"></i> 启用自动播放
                    </button>
                    <button class="btn btn-warning" id="test-local-audio">
                        <i class="fas fa-music"></i> 测试本地音频
                    </button>
                </div>
            </div>
            
            <!-- 视频监控区域 -->
            <div class="video-container">
                <video id="video" autoplay playsinline muted></video>
                <div class="video-overlay" id="video-overlay">
                    <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p>点击下方按钮开始摄像头监控</p>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">等待启动</span>
                </div>
            </div>
            
            <!-- 控制面板 -->
            <div class="control-panel">
                <h3 class="section-title"><i class="fas fa-cogs"></i> 控制面板</h3>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="start-btn">
                        <i class="fas fa-play"></i> 开始监控
                    </button>
                    <button class="btn btn-danger" id="stop-btn" disabled>
                        <i class="fas fa-stop"></i> 停止监控
                    </button>
                    <button class="btn btn-success" id="test-tts-btn">
                        <i class="fas fa-microphone"></i> 测试语音合成
                    </button>
                    <button class="btn btn-warning" id="test-beep-btn">
                        <i class="fas fa-bell"></i> 测试蜂鸣音
                    </button>
                </div>
                
                <!-- 语音类型选择 -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">提示声音类型：</label>
                    <select id="voice-type" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="beep">蜂鸣提示音</option>
                        <option value="local-tts">本地语音合成</option>
                        <option value="text-alert">文字提示</option>
                    </select>
                </div>
            </div>
            
            <!-- 坐姿提醒 -->
            <div class="alert-box" id="alert-box">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                    <div style="font-weight: bold; color: #b38f00;">坐姿提醒</div>
                    <div id="alert-message">请坐直身体，保持正确坐姿！</div>
                </div>
            </div>
            
            <!-- 计时器 -->
            <div class="timer-container">
                <div style="color: var(--primary); font-weight: 600;">距离下次休息还有</div>
                <div class="timer-display">
                    <span id="minutes">45</span>:<span id="seconds">00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="timer-progress"></div>
                </div>
            </div>
            
            <!-- 正确坐姿提示 -->
            <h3 class="section-title"><i class="fas fa-lightbulb"></i> 正确坐姿要点</h3>
            <div class="tips-grid">
                <div class="tip-card">
                    <h4><i class="fas fa-user"></i> 背部姿势</h4>
                    <p>背部挺直，轻微靠椅背，避免驼背</p>
                </div>
                <div class="tip-card">
                    <h4><i class="fas fa-eye"></i> 眼部距离</h4>
                    <p>眼睛离书本30-40厘米，视线向下15度</p>
                </div>
                <div class="tip-card">
                    <h4><i class="fas fa-hands"></i> 手臂位置</h4>
                    <p>手臂自然弯曲，肘部呈90度角</p>
                </div>
                <div class="tip-card">
                    <h4><i class="fas fa-shoe-prints"></i> 脚部姿势</h4>
                    <p>双脚平放地面，大腿与地面平行</p>
                </div>
            </div>
            
            <!-- 提醒记录 -->
            <h3 class="section-title"><i class="fas fa-history"></i> 提醒记录</h3>
            <div class="warning-history" id="warning-history">
                <div class="warning-item">
                    <i class="fas fa-info-circle"></i>
                    <div>系统准备就绪，点击"开始监控"按钮启动检测</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let videoStream = null;
        let isMonitoring = false;
        let monitorInterval = null;
        let timerInterval = null;
        let remainingTime = 45 * 60; // 45分钟
        let lastAlertTime = 0;
        let audioContext = null;
        let oscillator = null;
        let userInteracted = false;
        let voiceType = 'beep'; // 默认使用蜂鸣音
        
        // 警告语数组
        const warningMessages = [
            "小朋友，你的坐姿有点歪了哦，请坐直身体！",
            "注意坐姿！背要挺直，眼睛离书本不要太近。",
            "检测到你有点弯腰了，请挺直背部保护脊椎。",
            "坐姿不正确哦，请调整姿势，双脚平放地面。",
            "你的头太低了，请抬高一点，保护视力很重要。",
            "肩膀放松，不要一边高一边低，保持平衡。",
            "坐姿提醒：身体不要歪向一边，保持正直。",
            "小同学，请坐好，保持正确的写字姿势哦！"
        ];
        
        // DOM元素
        const video = document.getElementById('video');
        const videoOverlay = document.getElementById('video-overlay');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const alertBox = document.getElementById('alert-box');
        const alertMessage = document.getElementById('alert-message');
        const warningHistory = document.getElementById('warning-history');
        const minutesDisplay = document.getElementById('minutes');
        const secondsDisplay = document.getElementById('seconds');
        const timerProgress = document.getElementById('timer-progress');
        const voiceTypeSelect = document.getElementById('voice-type');
        const compatibilityFix = document.getElementById('compatibility-fix');
        const testTtsBtn = document.getElementById('test-tts-btn');
        const testBeepBtn = document.getElementById('test-beep-btn');
        const fixAudioContextBtn = document.getElementById('fix-audio-context');
        const enableAutoplayBtn = document.getElementById('enable-autoplay');
        const testLocalAudioBtn = document.getElementById('test-local-audio');
        
        // 初始化函数
        async function init() {
            // 检测浏览器类型
            const ua = navigator.userAgent.toLowerCase();
            const isHuaweiBrowser = ua.includes('huawei') || ua.includes('harmony');
            
            // 如果是华为浏览器，显示兼容性修复提示
            if (isHuaweiBrowser) {
                compatibilityFix.classList.add('show');
                addWarningMessage("检测到华为浏览器，部分功能可能需要额外设置");
            }
            
            // 检查语音合成支持
            if (!('speechSynthesis' in window)) {
                addWarningMessage("您的浏览器不支持语音合成，将使用蜂鸣音提示");
                testTtsBtn.disabled = true;
                testTtsBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> TTS不支持';
            }
            
            // 事件监听
            startBtn.addEventListener('click', startMonitoring);
            stopBtn.addEventListener('click', stopMonitoring);
            testTtsBtn.addEventListener('click', testTTS);
            testBeepBtn.addEventListener('click', testBeep);
            fixAudioContextBtn.addEventListener('click', fixAudioContext);
            enableAutoplayBtn.addEventListener('click', enableAutoplay);
            testLocalAudioBtn.addEventListener('click', testLocalAudio);
            voiceTypeSelect.addEventListener('change', function() {
                voiceType = this.value;
                addWarningMessage(`提示类型已切换为: ${this.options[this.selectedIndex].text}`);
            });
            
            // 用户交互监听（解锁音频）
            document.addEventListener('click', unlockAudio);
            document.addEventListener('touchstart', unlockAudio);
            
            // 初始化计时器
            updateTimerDisplay();
            
            // 尝试启动摄像头
            try {
                await startCamera();
            } catch (err) {
                console.log("摄像头初始化失败:", err);
            }
        }
        
        // 解锁音频（华为浏览器需要用户交互后才能播放声音）
        function unlockAudio() {
            if (!userInteracted) {
                userInteracted = true;
                console.log("用户已交互，音频已解锁");
                
                // 尝试创建一个非常短的静音音频来解锁音频上下文
                try {
                    const silentAudio = new Audio();
                    silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
                    silentAudio.volume = 0;
                    silentAudio.play().then(() => {
                        console.log("静音音频播放成功，音频上下文已解锁");
                    }).catch(e => {
                        console.log("静音音频播放失败:", e);
                    });
                } catch (e) {
                    console.log("静音音频创建失败:", e);
                }
            }
        }
        
        // 修复音频上下文（针对华为浏览器）
        function fixAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    addWarningMessage("音频上下文创建成功");
                } catch (e) {
                    addWarningMessage("音频上下文创建失败: " + e.message);
                }
            } else {
                addWarningMessage("音频上下文已存在");
            }
        }
        
        // 启用自动播放
        function enableAutoplay() {
            // 华为浏览器需要用户明确授权
            if (video.paused) {
                video.play().then(() => {
                    addWarningMessage("视频自动播放已启用");
                }).catch(e => {
                    addWarningMessage("视频自动播放被阻止: " + e.message);
                });
            }
            
            // 尝试播放测试音频
            testLocalAudio();
        }
        
        // 测试本地音频（使用Web Audio API）
        function testLocalAudio() {
            if (!userInteracted) {
                addWarningMessage("请先点击页面任意位置激活音频播放");
                return;
            }
            
            playBeepSound(800, 200); // 播放800Hz，200ms的蜂鸣音
            addWarningMessage("本地蜂鸣音测试完成");
        }
        
        // 启动摄像头
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                    audio: false
                });
                video.srcObject = videoStream;
                videoOverlay.style.display = 'none';
                addWarningMessage("摄像头已开启");
            } catch (err) {
                console.error("摄像头访问失败:", err);
                videoOverlay.innerHTML = `
                    <i class="fas fa-video-slash"></i>
                    <p>摄像头访问失败，将使用模拟检测模式</p>
                `;
                videoOverlay.style.display = 'flex';
                addWarningMessage("摄像头访问失败，使用模拟模式");
                
                // 启动模拟检测
                simulateDetection();
            }
        }
        
        // 开始监控
        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            statusDot.className = 'status-dot';
            statusText.textContent = "监控中 - 坐姿良好";
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // 开始姿态检测
            monitorInterval = setInterval(detectPose, 3000);
            
            // 开始计时器
            startTimer();
            
            addWarningMessage("坐姿监控已启动");
            
            // 初始语音提示
            playAlert("坐姿监控已经开始，我会帮你保持正确的坐姿哦！");
        }
        
        // 停止监控
        function stopMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            statusDot.className = 'status-dot';
            statusText.textContent = "监控已停止";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            clearInterval(monitorInterval);
            clearInterval(timerInterval);
            alertBox.classList.remove('show');
            
            addWarningMessage("坐姿监控已停止");
        }
        
        // 检测坐姿（模拟）
        function detectPose() {
            if (!isMonitoring) return;
            
            // 模拟30%的概率检测到不良坐姿
            const isBadPosture = Math.random() > 0.7;
            
            if (isBadPosture) {
                statusDot.className = 'status-dot danger';
                statusText.textContent = "坐姿需要调整";
                alertBox.classList.add('show');
                
                const randomMessage = warningMessages[Math.floor(Math.random() * warningMessages.length)];
                alertMessage.textContent = randomMessage;
                
                // 播放提醒
                playAlert(randomMessage);
                
                addWarningMessage(`坐姿提醒: ${randomMessage}`);
            } else {
                statusDot.className = 'status-dot';
                statusText.textContent = "坐姿良好";
                alertBox.classList.remove('show');
            }
        }
        
        // 模拟检测（摄像头不可用时）
        function simulateDetection() {
            setInterval(() => {
                if (!isMonitoring) return;
                
                const isBadPosture = Math.random() > 0.8;
                
                if (isBadPosture) {
                    statusDot.className = 'status-dot danger';
                    statusText.textContent = "模拟检测 - 坐姿需要调整";
                    alertBox.classList.add('show');
                    
                    const randomMessage = warningMessages[Math.floor(Math.random() * warningMessages.length)];
                    alertMessage.textContent = randomMessage;
                    
                    playAlert(randomMessage);
                    
                    addWarningMessage(`模拟检测: ${randomMessage}`);
                } else {
                    statusDot.className = 'status-dot';
                    statusText.textContent = "模拟检测 - 坐姿良好";
                    alertBox.classList.remove('show');
                }
            }, 3000);
        }
        
        // 播放提醒（根据选择的类型）
        function playAlert(message) {
            if (!isMonitoring) return;
            
            switch(voiceType) {
                case 'beep':
                    playBeepSound(600, 300);
                    break;
                case 'local-tts':
                    speakText(message);
                    break;
                case 'text-alert':
                    // 文字提示已经显示，不需要额外操作
                    break;
            }
        }
        
        // 播放蜂鸣音（Web Audio API）
        function playBeepSound(frequency, duration) {
            if (!userInteracted) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
                
            } catch (e) {
                console.log("蜂鸣音播放失败:", e);
                // 如果Web Audio API失败，尝试使用HTML5 Audio
                fallbackBeep();
            }
        }
        
        // 备用蜂鸣音（HTML5 Audio）
        function fallbackBeep() {
            if (!userInteracted) return;
            
            try {
                // 创建一个简单的beep声
                const audio = new Audio();
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                setTimeout(() => oscillator.stop(), 200);
                
            } catch (e) {
                console.log("备用蜂鸣音也失败:", e);
            }
        }
        
        // 语音合成
        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // 获取中文语音
            const voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                const chineseVoice = voices.find(v => v.lang.includes('zh'));
                if (chineseVoice) utterance.voice = chineseVoice;
            }
            
            try {
                speechSynthesis.speak(utterance);
            } catch (e) {
                console.log("语音合成失败:", e);
                // 语音合成失败时降级到蜂鸣音
                playBeepSound(800, 300);
            }
        }
        
        // 测试TTS
        function testTTS() {
            speakText("这是一条测试语音，坐姿监控系统工作正常。");
            addWarningMessage("语音合成测试完成");
        }
        
        // 测试蜂鸣音
        function testBeep() {
            playBeepSound(800, 300);
            addWarningMessage("蜂鸣音测试完成");
        }
        
        // 添加警告消息
        function addWarningMessage(message) {
            const now = new Date();
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const item = document.createElement('div');
            item.className = 'warning-item';
            item.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <div>
                    <span style="color: var(--primary); font-weight: 600;">${time}</span> 
                    <span>${message}</span>
                </div>
            `;
            
            warningHistory.prepend(item);
            
            // 限制显示数量
            if (warningHistory.children.length > 10) {
                warningHistory.removeChild(warningHistory.lastChild);
            }
        }
        
        // 开始计时器
        function startTimer() {
            remainingTime = 45 * 60;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();
                
                if (remainingTime <= 0) {
                    triggerRestBreak();
                    clearInterval(timerInterval);
                }
            }, 1000);
        }
        
        // 更新计时器显示
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            
            minutesDisplay.textContent = minutes.toString().padStart(2, '0');
            secondsDisplay.textContent = seconds.toString().padStart(2, '0');
            
            const progress = ((45 * 60 - remainingTime) / (45 * 60)) * 100;
            timerProgress.style.width = `${progress}%`;
        }
        
        // 触发休息
        function triggerRestBreak() {
            stopMonitoring();
            
            // 播放休息提醒
            playAlert("学习时间到！已经45分钟了，请站起来活动一下，看看远处，让眼睛休息5分钟。");
            
            addWarningMessage("学习时间已达45分钟，开始5分钟休息");
            
            // 5分钟后重新开始
            setTimeout(() => {
                if (confirm("休息时间结束，是否继续监控？")) {
                    startMonitoring();
                    playAlert("休息时间结束，请继续保持正确坐姿学习。");
                }
            }, 5 * 60 * 1000);
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
        
        // 确保视频可以播放（华为浏览器需要）
        video.addEventListener('click', function() {
            if (video.paused) {
                video.play().catch(e => {
                    console.log("视频播放被阻止:", e);
                });
            }
        });
    </script>
</body>
</html>
