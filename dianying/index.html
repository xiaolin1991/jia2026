<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™“æ—å½±é™¢,ä¸€ä¸ªåœ¨çº¿ç”µå½±è§‚çœ‹ç³»ç»Ÿ,ç®€å•æ²¡æœ‰å¹¿å‘Š.</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* === 1. æ ·å¼å˜é‡ === */
        :root { --sidebar-width: 240px; --header-height: 64px; }

        /* --- ä¸»é¢˜å®šä¹‰ --- */
        
        /* 1. æš—é»‘ (é»˜è®¤) */
        body.theme-dark {
            --bg-body: #121212; --bg-sidebar: #1e1e1e; --bg-card: #2c2c2c;
            --text-main: #fff; --text-sub: #aaa; --accent: #3ea6ff;
            --border: rgba(255,255,255,0.1); --hover: #333;
        }
        /* 2. äº®è‰² */
        body.theme-light {
            --bg-body: #f5f7fa; --bg-sidebar: #fff; --bg-card: #fff;
            --text-main: #333; --text-sub: #666; --accent: #0984e3;
            --border: #e0e0e0; --hover: #f0f0f0;
        }
        /* 3. ç½‘é£çº¢ */
        body.theme-red {
            --bg-body: #000; --bg-sidebar: #141414; --bg-card: #1f1f1f;
            --text-main: #e5e5e5; --text-sub: #999; --accent: #e50914;
            --border: #333; --hover: #333;
        }
        /* 4. ç§‘æŠ€è“ */
        body.theme-blue {
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --bg-card: #334155;
            --text-main: #e2e8f0; --text-sub: #94a3b8; --accent: #38bdf8;
            --border: #475569; --hover: #475569;
        }
        /* 5. æ¸…æ–°ç»¿ */
        body.theme-green {
            --bg-body: #f0fdf4; --bg-sidebar: #ffffff; --bg-card: #ffffff;
            --text-main: #14532d; --text-sub: #4ade80; --accent: #16a34a;
            --border: #bbf7d0; --hover: #dcfce7;
        }
        /* 6. é«˜è´µç´« */
        body.theme-purple {
            --bg-body: #2e1065; --bg-sidebar: #4c1d95; --bg-card: #5b21b6;
            --text-main: #ddd6fe; --text-sub: #a78bfa; --accent: #c084fc;
            --border: #6d28d9; --hover: #7c3aed;
        }
        /* 7. é»‘é‡‘ */
        body.theme-gold {
            --bg-body: #1c1c1c; --bg-sidebar: #2b2b2b; --bg-card: #383838;
            --text-main: #f1c40f; --text-sub: #bf953f; --accent: #f39c12;
            --border: #444; --hover: #4a4a4a;
        }

        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: sans-serif; height: 100vh; overflow: hidden; transition: background 0.3s; }
        
        .app-layout { display: flex; flex-direction: column; height: 100%; }
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* === 2. é¡¶éƒ¨æ  === */
        .header {
            height: var(--header-height); background: var(--bg-sidebar); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px;
            position: relative; z-index: 5000; 
        }

        .left-area { display: flex; align-items: center; gap: 15px; z-index: 5001; }
        .menu-toggle { font-size: 20px; cursor: pointer; padding: 5px; }
        .logo { font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; white-space: nowrap; }
        .logo i { color: var(--accent); }

        .search-box { 
            position: absolute; left: 50%; transform: translateX(-50%); 
            width: 40%; max-width: 500px; display: flex; 
            z-index: 5001; pointer-events: auto;
        }
        .search-box input {
            width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main);
            padding: 10px 40px 10px 20px; border-radius: 50px; outline: none;
        }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

        /* å³ä¾§æŒ‰é’® */
        .header-right { 
            position: absolute; right: 20px; top: 0; bottom: 0;
            display: flex; gap: 12px; align-items: center; 
            z-index: 9999;
        }
        .btn-icon {
            width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            background: var(--bg-body); color: var(--text-main); transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: auto; 
        }
        .btn-icon:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.1); background: var(--hover); }
        .btn-icon:active { transform: scale(0.95); }

        /* === 3. ä¾§è¾¹æ  === */
        .sidebar {
            width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: transform 0.3s; z-index: 4000;
        }
        
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 10px 0; }
        
        .group-name { font-size: 12px; color: var(--text-sub); padding: 15px 15px 5px; font-weight: bold; }
        .nav-item {
            padding: 12px 15px; margin: 2px 10px; border-radius: 6px; cursor: pointer;
            color: var(--text-sub); display: flex; align-items: center; gap: 10px; font-size: 14px;
        }
        .nav-item:hover { background: var(--hover); color: var(--text-main); }
        .nav-item.active { background: var(--accent); color: white; }
        .nav-item i { width: 18px; text-align: center; }

        /* ä¾§è¾¹æ åº•éƒ¨è”ç³»åŒº */
        .sidebar-footer {
            padding: 15px; border-top: 1px solid var(--border); background: var(--bg-sidebar);
            display: flex; flex-direction: column; gap: 10px;
        }
        .contact-title { font-size: 12px; color: var(--text-sub); font-weight: bold; margin-bottom: 5px; }
        
        .contact-link {
            display: flex; align-items: center; gap: 10px; padding: 8px 12px;
            background: var(--bg-card); border-radius: 8px; color: var(--text-main);
            text-decoration: none; font-size: 13px; border: 1px solid var(--border);
            cursor: pointer; transition: 0.2s;
        }
        .contact-link:hover { border-color: var(--accent); color: var(--accent); background: var(--hover); }
        .contact-link i { width: 16px; text-align: center; }

        .wechat-box {
            background: #fff; padding: 5px; border-radius: 8px; margin-top: 5px;
            animation: fadeIn 0.3s;
        }
        .wechat-box img { width: 100%; display: block; border-radius: 4px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === 4. å†…å®¹åŒº === */
        .content { 
            flex: 1; overflow-y: auto; padding: 20px; position: relative; 
            scroll-behavior: auto;
        }
        
        .cats { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .cat-btn {
            padding: 6px 18px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card);
            font-size: 13px; cursor: pointer; color: var(--text-main); transition: 0.2s;
        }
        .cat-btn.active { background: var(--text-main); color: var(--bg-body); border-color: var(--text-main); font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { cursor: pointer; position: relative; }
        .card:hover .poster { transform: scale(1.05); }
        .poster-wrap { width: 100%; aspect-ratio: 2/3; border-radius: 8px; overflow: hidden; background: #000; position: relative; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .poster { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: #fbbf24; font-size: 10px; padding: 2px 5px; border-radius: 4px; }
        .title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }

        .load-status { text-align: center; padding: 30px; color: var(--text-sub); font-size: 13px; width: 100%; clear: both; }

        /* === 5. æ’­æ”¾å™¨ === */
        .player-page { max-width: 1000px; margin: 0 auto; animation: fade 0.3s; padding-bottom: 50px; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 10px; overflow: hidden; margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        video { width: 100%; height: 100%; }
        .controls { padding: 20px 0; }
        .back-btn { display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; background: var(--bg-card); border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 15px; border: 1px solid var(--border); }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }

        .ep-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; max-height: 250px; overflow-y: auto; }
        .ep-item { text-align: center; padding: 8px; background: var(--bg-card); border-radius: 4px; font-size: 13px; cursor: pointer; border: 1px solid transparent; }
        .ep-item:hover { border-color: var(--accent); color: var(--text-main); }
        .ep-item.active { background: var(--accent); color: white; border-color: var(--accent); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: var(--header-height); bottom: 0; z-index: 6000; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
            .search-box { display: none; } 
            .grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .content { padding: 15px; }
            .video-box { border-radius: 0; margin: 0 -15px; width: auto; }
        }
    </style>
</head>
<body>

<div id="app" class="app-layout">
    
    <header class="header">
        <div class="left-area">
            <i class="fa-solid fa-bars menu-toggle" @click="toggleSidebar"></i>
            <div class="logo" @click="goHome">
                <i class="fa-solid fa-cloud"></i> æ™“æ—å½±é™¢
            </div>
        </div>

        <div class="search-box">
            <input v-model="keyword" @keyup.enter="doSearch" placeholder="æœç´¢å…¨ç½‘èµ„æº...">
            <i class="fa-solid fa-magnifying-glass search-icon" @click="doSearch"></i>
        </div>

        <div class="header-right">
            <div class="btn-icon" @click.stop="switchTheme" title="åˆ‡æ¢é¢œè‰²">
                <i class="fa-solid fa-palette"></i>
            </div>
            <div class="btn-icon">
                <i class="fa-regular fa-user"></i>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar" :class="{ open: isSidebarOpen }">
            <div class="sidebar-scroll">
                <div class="group-name">å½“å‰çº¿è·¯</div>
                <div class="nav-item active">
                    <i class="fa-solid fa-tower-broadcast"></i> {{ currentSourceName }}
                </div>

                <div class="group-name">ç»¼åˆèµ„æº</div>
                <div v-for="s in generalSources" :key="s.key" 
                     class="nav-item" :class="{active: currentSourceKey === s.key}"
                     @click="changeSource(s)">
                    <i :class="s.icon"></i> {{ s.name }}
                </div>

                <div v-if="showSpecialSection">
                    <div class="group-name" style="color:#e74c3c; margin-top:20px;">ç‰¹æ®Š / ç¦åˆ©</div>
                    <div v-for="s in specialSources" :key="s.key" 
                         class="nav-item" :class="{active: currentSourceKey === s.key}"
                         @click="changeSource(s)">
                        <i :class="s.icon"></i> {{ s.name }}
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="contact-title">æœ‰é—®é¢˜è”ç³»æˆ‘</div>
                
                <a href="https://github.com/xiaolin1991" target="_blank" class="contact-link">
                    <i class="fa-brands fa-github"></i> GitHub
                </a>
                
                <div class="contact-link" @click="toggleWechat">
                    <i class="fa-brands fa-weixin"></i> å¾®ä¿¡å’¨è¯¢
                </div>

                <div v-if="showWechat" class="wechat-box">
                    <img src="./wechat.png" alt="wechat.png">
                </div>
            </div>
        </aside>

        <div v-if="isSidebarOpen" @click="toggleSidebar" 
             style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:5500;"></div>

        <main class="content" ref="contentRef" @scroll="handleScroll">
            
            <div v-if="!isPlayerMode">
                <div class="cats">
                    <div class="cat-btn" :class="{active: currentCat==='latest'}" @click="changeCat('latest')">æœ€æ–°</div>
                    <div class="cat-btn" :class="{active: currentCat==='movie'}" @click="changeCat('movie')">ç”µå½±</div>
                    <div class="cat-btn" :class="{active: currentCat==='tv'}" @click="changeCat('tv')">å‰§é›†</div>
                    <div class="cat-btn" :class="{active: currentCat==='anime'}" @click="changeCat('anime')">åŠ¨æ¼«</div>
                    <div class="cat-btn" :class="{active: currentCat==='variety'}" @click="changeCat('variety')">ç»¼è‰º</div>
                </div>

                <div class="grid">
                    <div class="card" v-for="item in list" :key="item.vod_id" @click="openPlayer(item)">
                        <div class="poster-wrap">
                            <img :src="item.vod_pic" class="poster" @error="imgError" loading="lazy">
                            <div class="badge">{{ item.vod_remarks || item.vod_year }}</div>
                        </div>
                        <div class="title">{{ item.vod_name }}</div>
                    </div>
                </div>

                <div class="load-status">
                    <span v-if="loading && page===1">åˆå§‹åŒ–ä¸­...</span>
                    <span v-else-if="loading"><i class="fa-solid fa-spinner fa-spin"></i> åŠ è½½ä¸­...</span>
                    <span v-else-if="!hasMore">ğŸ‰ å·²åŠ è½½å…¨éƒ¨</span>
                    <span v-else-if="list.length===0">æš‚æ— æ•°æ®</span>
                    <span v-else>å‘ä¸Šæ»‘åŠ¨åŠ è½½æ›´å¤š</span>
                </div>
            </div>

            <div v-else class="player-page">
                <div class="back-btn" @click="closePlayer">
                    <i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨
                </div>

                <div class="video-box">
                    <video id="player" controls autoplay playsinline></video>
                </div>

                <div class="controls">
                    <h2 style="margin:0;">{{ currentVod.vod_name }}</h2>
                    <div style="font-size:13px; color:var(--text-sub); margin-top:5px;">
                        æ­£åœ¨æ’­æ”¾: {{ currentEpName }} <span style="margin-left:10px; color:var(--accent)">({{ currentSourceName }})</span>
                    </div>

                    <div class="ep-list">
                        <div v-for="(url, name) in episodes" :key="name" 
                             class="ep-item" :class="{active: currentPlayUrl === url}"
                             @click="switchEp(name, url)">
                            {{ name }}
                        </div>
                    </div>
                </div>

                <h3 style="margin-top:30px;">çŒœä½ å–œæ¬¢</h3>
                <div class="grid">
                    <div class="card" v-for="item in recommendList" :key="item.vod_id" @click="openPlayer(item)">
                        <div class="poster-wrap">
                            <img :src="item.vod_pic" class="poster" @error="imgError">
                            <div class="badge">{{ item.vod_remarks }}</div>
                        </div>
                        <div class="title">{{ item.vod_name }}</div>
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<script>
    const { createApp, ref, nextTick, onMounted } = Vue;

    createApp({
        setup() {
            // â­â­â­ ä½ çš„ä¸“ç”¨ API â­â­â­
            const API_PROXY = 'https://cf-dianying.xiaolin4914.workers.dev/'; 
            // â­â­â­ éšè—ç¦åˆ©åŒºçš„å¼€å…³ â­â­â­
            // true = æ˜¾ç¤º (å¼€å¯ç¦åˆ©)
            // false = éšè— (å…³é—­ç¦åˆ©)
            const showSpecialSection = ref(true); // ç¦åˆ©åŒºå¼€å…³
            const showWechat = ref(false); // å¾®ä¿¡äºŒç»´ç å¼€å…³

            // çŠ¶æ€
            const isSidebarOpen = ref(false);
            const themes = ['theme-dark', 'theme-light', 'theme-red', 'theme-blue', 'theme-green', 'theme-purple', 'theme-gold'];
            const currentTheme = ref('theme-dark');
            const isPlayerMode = ref(false);
            const loading = ref(false);
            const contentRef = ref(null);

            // æ•°æ®
            const list = ref([]);
            const recommendList = ref([]);
            const keyword = ref('');
            const currentCat = ref('latest');
            const page = ref(1);
            const hasMore = ref(true);

            // èµ„æºåˆ—è¡¨
            const generalSources = [
                { key: 'guangsu', name: 'å…‰é€Ÿèµ„æº', icon: 'fa-solid fa-bolt' },
                { key: 'liangzi', name: 'é‡å­èµ„æº', icon: 'fa-solid fa-atom' },
                { key: 'hongniu', name: 'çº¢ç‰›èµ„æº', icon: 'fa-solid fa-bullhorn' },
                { key: 'ikun', name: 'iKunèµ„æº', icon: 'fa-solid fa-basketball' },
                { key: 'tianya', name: 'å¤©æ¶¯å½±è§†', icon: 'fa-solid fa-mountain-sun' },
                { key: 'kuaiche', name: 'å¿«è½¦èµ„æº', icon: 'fa-solid fa-truck-fast' },
                { key: 'wujin', name: 'æ— å°½èµ„æº', icon: 'fa-solid fa-infinity' },
                { key: 'zuidazy', name: 'æœ€å¤§èµ„æº', icon: 'fa-solid fa-maximize' },
                { key: 'yinghua', name: 'æ¨±èŠ±èµ„æº', icon: 'fa-solid fa-fan' },
                { key: 'douban', name: 'è±†ç“£èµ„æº', icon: 'fa-brands fa-douban' },
                { key: 'subo', name: 'é€Ÿæ’­èµ„æº', icon: 'fa-solid fa-forward' },
                { key: 'uku', name: 'Ué…·èµ„æº', icon: 'fa-solid fa-u' },
                { key: 'shanhai', name: 'å±±æµ·èµ„æº', icon: 'fa-solid fa-water' },
                { key: 'xinlang', name: 'æ–°æµªèµ„æº', icon: 'fa-brands fa-weibo' },
                { key: 'wangwang', name: 'æ—ºæ—ºèµ„æº', icon: 'fa-solid fa-dog' },
                { key: 'baofeng', name: 'æš´é£èµ„æº', icon: 'fa-solid fa-wind' },
                { key: 'jisu', name: 'æé€Ÿèµ„æº', icon: 'fa-solid fa-gauge-high' },
                { key: 'maoyan', name: 'çŒ«çœ¼èµ„æº', icon: 'fa-solid fa-cat' },
                { key: 'suoni', name: 'ç´¢å°¼èµ„æº', icon: 'fa-solid fa-gamepad' },
                { key: 'maotai', name: 'èŒ…å°èµ„æº', icon: 'fa-solid fa-wine-bottle' },
                { key: 'huya', name: 'è™ç‰™èµ„æº', icon: 'fa-solid fa-paw' },
                { key: 'jinying', name: 'é‡‘é¹°èµ„æº', icon: 'fa-solid fa-feather' },
                { key: 'shandian', name: 'é—ªç”µèµ„æº', icon: 'fa-solid fa-bolt-lightning' },
                { key: 'feifan', name: 'éå‡¡èµ„æº', icon: 'fa-solid fa-plane' },
                { key: 'piaoling', name: 'é£˜é›¶èµ„æº', icon: 'fa-solid fa-snowflake' },
                { key: 'modu', name: 'é­”éƒ½èµ„æº', icon: 'fa-solid fa-city' },
                { key: 'yaya', name: 'é¸­é¸­èµ„æº', icon: 'fa-solid fa-kiwi-bird' },
                { key: 'ckzy', name: 'CKèµ„æº', icon: 'fa-solid fa-cube' }
            ];

            const specialSources = [
                { key: '91madou', name: '91éº»è±†', icon: 'fa-solid fa-fire' },
                { key: 'jkun', name: 'JKUNèµ„æº', icon: 'fa-solid fa-music' },
                { key: 'siwa', name: 'ä¸è¢œèµ„æº', icon: 'fa-solid fa-socks' },
                { key: 'cl', name: 'ç™¾ä¸‡èµ„æº', icon: 'fa-solid fa-leaf' },
                { key: '155zy', name: '155èµ„æº', icon: 'fa-solid fa-1' },
                { key: 'souav', name: 'SouAV', icon: 'fa-solid fa-video' },
                { key: 'youyou', name: 'ä¼˜ä¼˜èµ„æº', icon: 'fa-solid fa-y' },
                { key: 'zuise', name: 'æœ€è‰²èµ„æº', icon: 'fa-solid fa-heart' },
                { key: 'aosika', name: 'å¥¥æ–¯å¡', icon: 'fa-solid fa-trophy' },
                { key: 'xiaoji', name: 'å°é¸¡èµ„æº', icon: 'fa-solid fa-egg' },
                { key: 'xing', name: 'å¹¸èµ„æº', icon: 'fa-solid fa-star' },
                { key: 'xingba', name: 'æå§èµ„æº', icon: 'fa-solid fa-lemon' },
                { key: 'didi', name: 'æ»´æ»´èµ„æº', icon: 'fa-solid fa-car' },
                { key: 'yutu', name: 'ç‰å…”èµ„æº', icon: 'fa-solid fa-rabbit' },
                { key: 'baipiao', name: 'ç™½å«–èµ„æº', icon: 'fa-solid fa-gift' },
                { key: 'meishaonv', name: 'ç¾å°‘å¥³', icon: 'fa-solid fa-person-dress' },
                { key: 'lebo', name: 'ä¹æ’­èµ„æº', icon: 'fa-solid fa-play' },
                { key: 'taohua', name: 'æ¡ƒèŠ±èµ„æº', icon: 'fa-solid fa-spa' }
            ];

            const currentSourceKey = ref('guangsu');
            const currentSourceName = ref('å…‰é€Ÿèµ„æº');

            // æ’­æ”¾å™¨
            const currentVod = ref(null);
            const episodes = ref({});
            const currentPlayUrl = ref('');
            const currentEpName = ref('');
            let hls = null;

            // æ¢è‚¤é€»è¾‘
            const applyTheme = (theme) => {
                currentTheme.value = theme;
                document.body.className = theme; 
                localStorage.setItem('cloudtv_theme_v9', theme);
            };

            const switchTheme = () => {
                let idx = themes.indexOf(currentTheme.value);
                if(idx === -1) idx = 0;
                idx = (idx + 1) % themes.length;
                applyTheme(themes[idx]);
            };

            const toggleSidebar = () => isSidebarOpen.value = !isSidebarOpen.value;
            const toggleWechat = () => showWechat.value = !showWechat.value;

            // åŠ è½½é€»è¾‘
            const fetchData = async (isLoadMore = false) => {
                if(loading.value) return; 
                if(!hasMore.value && isLoadMore) return; 

                loading.value = true;
                
                if (!isLoadMore) {
                    page.value = 1;
                    list.value = [];
                    hasMore.value = true;
                    if(contentRef.value) contentRef.value.scrollTop = 0;
                }

                try {
                    const target = currentSourceKey.value;
                    let url = `${API_PROXY}?from=${target}&ac=detail&pg=${page.value}`;
                    
                    if(keyword.value) url += `&wd=${encodeURIComponent(keyword.value)}`;
                    else if (currentCat.value !== 'latest') {
                        const map = { movie:'ç”µå½±', tv:'ç”µè§†å‰§', anime:'åŠ¨æ¼«', variety:'ç»¼è‰º' };
                        url += `&wd=${encodeURIComponent(map[currentCat.value])}`;
                    }

                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if(data.list && data.list.length > 0) {
                        if (isLoadMore) {
                            list.value = [...list.value, ...data.list];
                        } else {
                            list.value = data.list;
                        }
                        page.value++;
                    } else {
                        hasMore.value = false;
                    }
                } catch(e) { 
                    console.error(e);
                    hasMore.value = false;
                }
                loading.value = false;
            };

            const handleScroll = (e) => {
                const { scrollTop, scrollHeight, clientHeight } = e.target;
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    if (!loading.value && hasMore.value) {
                        fetchData(true);
                    }
                }
            };

            const changeSource = (s) => {
                currentSourceKey.value = s.key;
                currentSourceName.value = s.name;
                keyword.value = '';
                isPlayerMode.value = false;
                fetchData(false);
                if(window.innerWidth < 768) isSidebarOpen.value = false;
            };

            const changeCat = (cat) => {
                currentCat.value = cat;
                keyword.value = '';
                fetchData(false);
            };

            const doSearch = () => {
                if(!keyword.value) return;
                currentCat.value = 'search';
                fetchData(false);
            };

            // æ‰“å¼€æ’­æ”¾å™¨
            const openPlayer = (item) => {
                currentVod.value = item;
                const urlStr = item.vod_play_url;
                const eps = {};
                const split = urlStr.includes('$$$') ? '$$$' : '#';
                const arr = urlStr.split(split);
                let first = null;

                arr.forEach(seg => {
                    const p = seg.split('$');
                    if(p.length >= 2) {
                        const n = p[0];
                        const u = p[p.length-1];
                        if(u.includes('.m3u8') || u.includes('.mp4')) {
                            eps[n] = u;
                            if(!first) first = {n, u};
                        }
                    }
                });
                
                if(!first && arr.length > 0) {
                    const p = arr[0].split('$');
                    first = { n:'æ’­æ”¾', u: p[p.length-1] };
                    eps['æ’­æ”¾'] = first.u;
                }

                episodes.value = eps;
                if(first) switchEp(first.n, first.u);

                recommendList.value = list.value.filter(v=>v.vod_id!==item.vod_id).slice(0, 12);
                
                isPlayerMode.value = true;
                nextTick(() => {
                    if(contentRef.value) contentRef.value.scrollTop = 0;
                });
            };

            const switchEp = (name, url) => {
                currentEpName.value = name;
                currentPlayUrl.value = url;
                setTimeout(() => {
                    const video = document.getElementById('player');
                    if(!video) return;
                    if (Hls.isSupported()) {
                        if(hls) hls.destroy();
                        hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = url;
                        video.play();
                    }
                }, 100);
            };

            const closePlayer = () => {
                isPlayerMode.value = false;
                if(hls) hls.destroy();
            };

            const goHome = () => {
                keyword.value = '';
                isPlayerMode.value = false;
                currentCat.value = 'latest';
                fetchData(false);
            };

            const imgError = (e) => e.target.src = 'https://via.placeholder.com/300x450?text=No+Cover';

            onMounted(() => {
                const saved = localStorage.getItem('cloudtv_theme_v9');
                if(saved && themes.includes(saved)) {
                    applyTheme(saved);
                } else {
                    applyTheme('theme-dark');
                }
                fetchData(false);
            });

            return {
                contentRef, showSpecialSection, showWechat,
                isSidebarOpen, toggleSidebar, toggleWechat,
                currentTheme, switchTheme,
                generalSources, specialSources, currentSourceKey, currentSourceName, changeSource,
                currentCat, changeCat, keyword, doSearch,
                list, loading, isPlayerMode,
                openPlayer, closePlayer, goHome,
                currentVod, episodes, currentPlayUrl, currentEpName, switchEp,
                recommendList, imgError,
                handleScroll, page, hasMore
            };
        }
    }).mount('#app');
</script>
</body>
</html>