<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™“æ—æŠ€æœ¯ - æ™ºèƒ½å‘å‹è®¾è®¡å®¤</title>
    <style>
        :root {
            --primary-color: #ff00cc;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1a0b2e 0%, #4a195b 50%, #16245a 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .brand-title {
            font-size: 2.5rem; font-weight: 900; text-align: center;
            background: linear-gradient(90deg, #ff00cc, #333399, #00ffff, #ff00cc);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes shine { to { background-position: 200% center; } }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(20px);
        }
        .login-box {
            background: var(--glass-bg); padding: 40px; border-radius: 20px;
            border: var(--glass-border); text-align: center;
        }
        input { padding: 10px; border-radius: 8px; border: none; margin-top: 15px; width: 200px; text-align:center;}
        button {
            padding: 10px 20px; border-radius: 8px; border: none;
            background: linear-gradient(45deg, #ff00cc, #333399);
            color: white; font-weight: bold; cursor: pointer; margin-top: 15px;
            transition: all 0.3s;
        }
        button:hover { filter: brightness(1.1); transform: scale(1.02); }
        button:active { transform: scale(0.98); }

        #main-app {
            display: none; width: 90%; max-width: 1200px; height: 90vh;
            background: var(--glass-bg); border-radius: 25px; border: var(--glass-border);
            padding: 20px; box-sizing: border-box;
            grid-template-columns: 1fr 320px; gap: 20px;
        }

        .camera-section {
            position: relative; background: #000; border-radius: 15px;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        /* è§†é¢‘å’Œå®šæ ¼ç…§ç‰‡é‡å  */
        #video, #frozen-photo { 
            width: 100%; height: 100%; object-fit: cover; 
            transform: scaleX(-1); /* é•œåƒ */
            position: absolute; top:0; left:0;
        }
        #frozen-photo { display: none; z-index: 2; } /* é»˜è®¤éšè—å®šæ ¼ç…§ */
        
        #hair-overlay {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 300px; cursor: move; transition: src 0.3s ease;
            display: none; z-index: 3; pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€åˆ°æ»‘å— */
        }

        .controls-panel {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }

        #loading-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
            color: #00ffff; font-size: 1rem; text-align: center; padding: 20px;
            line-height: 1.5;
        }

        .hair-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hair-option {
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;
            cursor: pointer; text-align: center; border: 2px solid transparent;
        }
        .hair-option.active { border-color: #00ffff; background: rgba(0,255,255,0.2); }
        .hair-option img { width: 100%; height: 60px; object-fit: contain; }
        
        .control-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }
        input[type=range] { width: 100%; cursor: pointer; }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; margin-top: auto; }
        .btn-take { background: #ff9900; flex: 1; color: black; }
        .btn-upload { background: #00cc66; flex: 1; display: none; /* é»˜è®¤éšè—ä¸Šä¼ æŒ‰é’® */ }
        .btn-reset { background: #ff3366; flex: 1; display: none; /* é»˜è®¤éšè—é‡æ‹æŒ‰é’® */ }

        @media (max-width: 768px) {
            #main-app { grid-template-columns: 1fr; grid-template-rows: 1fr auto; height: 95vh;}
            .controls-panel { max-height: 350px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="brand-title">æ™“æ—æŠ€æœ¯</h1>
        <div class="login-box">
            <p>æ™ºèƒ½å‘å‹è®¾è®¡å®¤</p>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
            <br>
            <button onclick="checkPassword()">è¿›å…¥ç³»ç»Ÿ</button>
            <p id="login-error" style="color:#ff3366; font-size:12px; margin-top:10px; display:none;">å¯†ç é”™è¯¯</p>
        </div>
    </div>

    <div id="main-app">
        <div class="camera-section">
            <div id="loading-mask">
                <div style="font-size:30px; margin-bottom:10px;">â˜ï¸</div>
                <div id="loading-text">æ­£åœ¨è¿æ¥...</div>
            </div>
            <video id="video" autoplay playsinline></video>
            <canvas id="frozen-photo"></canvas>
            <img id="hair-overlay" crossorigin="anonymous" src="">
        </div>

        <div class="controls-panel">
            <h2 style="margin:0; border-bottom:1px solid #555; padding-bottom:10px;">è®¾è®¡é¢æ¿</h2>
            
            <div id="step-tip" style="background:rgba(0,255,255,0.1); padding:10px; border-radius:8px; font-size:0.9rem;">
                ç¬¬1æ­¥ï¼šè¯·æ‘†å¥½å§¿åŠ¿ï¼Œç‚¹å‡»ä¸‹æ–¹â€œå®šæ ¼æ‹ç…§â€
            </div>

            <div id="design-controls" style="display:none; opacity: 0.5; pointer-events: none; transition: all 0.3s;">
                <h3>1. é€‰æ‹©å‘å‹è¯•æˆ´</h3>
                <div class="hair-grid">
                    <div class="hair-option" onclick="selectHair(this, 'https://cdn-icons-png.flaticon.com/512/9408/9408201.png')">
                        <img src="https://cdn-icons-png.flaticon.com/512/9408/9408201.png"><br>æ³¢æ³¢å¤´
                    </div>
                    <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408197.png')">
                        <img src="https://cdn-icons-png.flaticon.com/512/9408/9408197.png"><br>å¤§æ³¢æµª
                    </div>
                    <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408192.png')">
                        <img src="https://cdn-icons-png.flaticon.com/512/9408/9408192.png"><br>æ½®é…·ç‹¼å°¾
                    </div>
                    <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/12349/12349764.png')">
                        <img src="https://cdn-icons-png.flaticon.com/512/12349/12349764.png"><br>å•†åŠ¡èƒŒå¤´
                    </div>
                </div>

                <h3>2. å¾®è°ƒä½ç½®</h3>
                <div class="control-group">
                    <label>å¤§å°ç¼©æ”¾</label>
                    <input type="range" min="150" max="600" value="300" oninput="updateHairStyle('width', this.value + 'px')">
                </div>
                <div class="control-group">
                    <label>ä¸Šä¸‹ç§»åŠ¨</label>
                    <input type="range" min="0" max="60" value="20" oninput="updateHairStyle('top', this.value + '%')">
                </div>
                <div class="control-group">
                    <label>å·¦å³ç§»åŠ¨</label>
                    <input type="range" min="-100" max="100" value="0" oninput="document.getElementById('hair-overlay').style.marginLeft = this.value + 'px'">
                </div>
            </div>

            <div class="btn-group">
                <button id="btnTake" class="btn-take" onclick="takePhoto()">ğŸ“¸ å®šæ ¼æ‹ç…§</button>
                <button id="btnReset" class="btn-reset" onclick="resetCamera()">ğŸ”„ é‡æ‹</button>
                <button id="btnUpload" class="btn-upload" onclick="uploadResult()">â˜ï¸ ç¡®è®¤ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const CONFIG = {
            loginPassword: "123",       // ç½‘ç«™å¯†ç 
            uploadUrl: "https://image.hanglinkj.com/upload",
            uploadToken: "188"          // AUTH_CODE
        };

        // ================= çŠ¶æ€å˜é‡ =================
        let isPhotoTaken = false;
        let currentStream = null;

        // ================= é€»è¾‘åŒº =================
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === CONFIG.loginPassword) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'grid';
                startCamera();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                currentStream = stream;
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿ä½¿ç”¨HTTPSæˆ–å…è®¸æƒé™ã€‚");
            }
        }

        // --- æ–°æµç¨‹ï¼š1. å®šæ ¼æ‹ç…§ ---
        function takePhoto() {
            const video = document.getElementById('video');
            const frozenCanvas = document.getElementById('frozen-photo');
            const ctx = frozenCanvas.getContext('2d');

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
            frozenCanvas.width = video.videoWidth;
            frozenCanvas.height = video.videoHeight;

            // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§ï¼ˆå®šæ ¼ï¼‰
            ctx.translate(frozenCanvas.width, 0); ctx.scale(-1, 1); // é•œåƒ
            ctx.drawImage(video, 0, 0);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // æ˜¾ç¤ºå®šæ ¼ç…§ï¼Œæš‚åœè§†é¢‘æµï¼ˆçœç”µï¼‰
            frozenCanvas.style.display = 'block';
            video.pause();
            
            // æ›´æ–°UIçŠ¶æ€
            isPhotoTaken = true;
            document.getElementById('step-tip').innerText = "ç¬¬2æ­¥ï¼šè¯·ç‚¹å‡»ä¸Šæ–¹å‘å‹è¿›è¡Œè¯•æˆ´ï¼Œå¹¶ä½¿ç”¨æ»‘å—è°ƒæ•´";
            document.getElementById('step-tip').style.background = "rgba(0,255,0,0.2)";
            
            // æ¿€æ´»è®¾è®¡åŒºåŸŸå’ŒæŒ‰é’®
            const designControls = document.getElementById('design-controls');
            designControls.style.opacity = '1';
            designControls.style.pointerEvents = 'auto';
            
            document.getElementById('btnTake').style.display = 'none';
            document.getElementById('btnReset').style.display = 'block';
            document.getElementById('btnUpload').style.display = 'block';
        }

        // --- æ–°æµç¨‹ï¼šé‡æ‹ ---
        function resetCamera() {
            const video = document.getElementById('video');
            document.getElementById('frozen-photo').style.display = 'none';
            document.getElementById('hair-overlay').style.display = 'none';
            video.play();

            isPhotoTaken = false;
            document.getElementById('step-tip').innerText = "ç¬¬1æ­¥ï¼šè¯·æ‘†å¥½å§¿åŠ¿ï¼Œç‚¹å‡»ä¸‹æ–¹â€œå®šæ ¼æ‹ç…§â€";
            document.getElementById('step-tip').style.background = "rgba(0,255,255,0.1)";

            const designControls = document.getElementById('design-controls');
            designControls.style.opacity = '0.5';
            designControls.style.pointerEvents = 'none';
            
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.hair-option').forEach(el => el.classList.remove('active'));

            document.getElementById('btnTake').style.display = 'block';
            document.getElementById('btnReset').style.display = 'none';
            document.getElementById('btnUpload').style.display = 'none';
        }

        // --- å‘å‹äº¤äº’ ---
        function selectHair(element, src) {
            // ç§»é™¤å…¶ä»–é«˜äº®
            document.querySelectorAll('.hair-option').forEach(el => el.classList.remove('active'));
            // é«˜äº®å½“å‰ç‚¹å‡»
            element.classList.add('active');
            changeHair(src);
        }

        function changeHair(src) {
            if (!isPhotoTaken) return; // æ²¡æ‹ç…§ä¸èƒ½é€‰
            const overlay = document.getElementById('hair-overlay');
            overlay.src = src;
            overlay.style.display = 'block';
        }

        function updateHairStyle(prop, value) {
            document.getElementById('hair-overlay').style[prop] = value;
        }

        // --- æ ¸å¿ƒï¼šåˆæˆå¹¶ä¸Šä¼  ---
        async function uploadResult() {
            if (!isPhotoTaken) return;
            
            const overlay = document.getElementById('hair-overlay');
            if (overlay.style.display === 'none') {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå‘å‹ï¼");
                return;
            }

            const loading = document.getElementById('loading-mask');
            const logText = document.getElementById('loading-text');
            loading.style.display = 'flex';
            logText.innerText = "æ­£åœ¨åˆæˆæœ€ç»ˆæ•ˆæœå›¾...";

            // ä½¿ç”¨ä¸€ä¸ªæ–°çš„ä¸´æ—¶ç”»å¸ƒè¿›è¡Œåˆæˆ
            const finalCanvas = document.createElement('canvas');
            const frozenCanvas = document.getElementById('frozen-photo');
            finalCanvas.width = frozenCanvas.width;
            finalCanvas.height = frozenCanvas.height;
            const ctx = finalCanvas.getContext('2d');

            // 1. ç»˜åˆ¶å®šæ ¼çš„åº•å›¾
            ctx.drawImage(frozenCanvas, 0, 0);

            // 2. ç»˜åˆ¶å‘å‹ (éœ€è¦è®¡ç®—å½“å‰DOMå…ƒç´ ç›¸å¯¹äºç”»å¸ƒçš„ä½ç½®)
            const rect = overlay.getBoundingClientRect();
            const containerRect = document.querySelector('.camera-section').getBoundingClientRect();
            
            // è®¡ç®—æ¯”ä¾‹å› å­ï¼ˆå› ä¸ºæ˜¾ç¤ºå¤§å°å¯èƒ½å’Œå®é™…ç”»å¸ƒå¤§å°ä¸ä¸€æ ·ï¼‰
            const scaleX = finalCanvas.width / containerRect.width;
            const scaleY = finalCanvas.height / containerRect.height;

            // è®¡ç®—å‘å‹åœ¨ç”»å¸ƒä¸Šçš„å®é™…ä½ç½®å’Œå¤§å°
            const hairX = (rect.left - containerRect.left) * scaleX;
            const hairY = (rect.top - containerRect.top) * scaleY;
            const hairW = rect.width * scaleX;
            const hairH = rect.height * scaleY;

            try {
                ctx.drawImage(overlay, hairX, hairY, hairW, hairH);
            } catch(e){ console.log("è·¨åŸŸç»˜åˆ¶å¤±è´¥"); }

            // 3. ç”ŸæˆBlobå¹¶ä¸Šä¼ 
            const designBlob = await new Promise(r => finalCanvas.toBlob(r, 'image/jpeg', 0.95));

            logText.innerHTML = "æ­£åœ¨ä¸Šä¼ åˆ°å›¾åºŠ...<br>è¯·è€å¿ƒç­‰å¾…";
            
            try {
                // è¿™é‡Œæˆ‘ä»¬åªä¸Šä¼ æœ€ç»ˆçš„è®¾è®¡å›¾ï¼Œå› ä¸ºåŸå›¾å·²ç»å®šæ ¼åœ¨ç”»å¸ƒä¸Šäº†ï¼Œå¦‚æœéœ€è¦ä¹Ÿå¯ä»¥åˆ†åˆ«ä¸Šä¼ 
                const resUrl = await uploadWithRetry(designBlob, 'design_final');
                
                // ä¸Šä¼ æˆåŠŸåï¼Œç»™ä¸ªæ¼‚äº®çš„æç¤ºï¼Œå¹¶è¯¢é—®æ˜¯å¦é‡æ¥
                if (confirm(`âœ… ä¸Šä¼ æˆåŠŸï¼\n\næ‚¨çš„å‘å‹è®¾è®¡å›¾å·²ä¿å­˜ã€‚\næ˜¯å¦é‡æ–°è®¾è®¡ï¼Ÿ`)) {
                    resetCamera();
                }
            } catch (err) {
                alert("âŒ ä¸Šä¼ å¤±è´¥: \n" + err.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // --- ä¸Šä¼ å‡½æ•° (ä¿æŒä¹‹å‰çš„ä¿®å¤ç‰ˆ) ---
        async function uploadWithRetry(blob, type) {
            const formData = new FormData();
            formData.append('file', blob, `xiaolin_${type}_${Date.now()}.jpg`);
            formData.append('authCode', CONFIG.uploadToken); 
            const targetUrl = `${CONFIG.uploadUrl}?authCode=${CONFIG.uploadToken}`;

            const response = await fetch(targetUrl, {
                method: 'POST',
                body: formData
            });

            const text = await response.text();
            let json;
            try { json = JSON.parse(text); } catch (e) {
                throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${text.substring(0, 100)}`);
            }

            const imgUrl = json.src || json.url || (json.data && json.data.url) || (json[0] && json[0].src);
            
            if (imgUrl) {
                return imgUrl.startsWith('http') ? imgUrl : 'https://image.hanglinkj.com' + imgUrl;
            } else {
                throw new Error(json.msg || json.error || "æœªè¿”å›é“¾æ¥");
            }
        }
    </script>
</body>
</html>