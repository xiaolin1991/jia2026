<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™“æ—æŠ€æœ¯ - æ™ºèƒ½å‘å‹è®¾è®¡å®¤</title>
    <style>
        :root {
            --primary-color: #ff00cc;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1a0b2e 0%, #4a195b 50%, #16245a 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .brand-title {
            font-size: 2.5rem; font-weight: 900; text-align: center;
            background: linear-gradient(90deg, #ff00cc, #333399, #00ffff, #ff00cc);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes shine { to { background-position: 200% center; } }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(20px);
        }
        .login-box {
            background: var(--glass-bg); padding: 40px; border-radius: 20px;
            border: var(--glass-border); text-align: center;
        }
        input { padding: 10px; border-radius: 8px; border: none; margin-top: 15px; width: 200px; text-align:center;}
        button {
            padding: 10px 20px; border-radius: 8px; border: none;
            background: linear-gradient(45deg, #ff00cc, #333399);
            color: white; font-weight: bold; cursor: pointer; margin-top: 15px;
        }

        #main-app {
            display: none; width: 90%; max-width: 1200px; height: 90vh;
            background: var(--glass-bg); border-radius: 25px; border: var(--glass-border);
            padding: 20px; box-sizing: border-box;
            grid-template-columns: 1fr 300px; gap: 20px;
        }

        .camera-section {
            position: relative; background: #000; border-radius: 15px;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        #hair-overlay {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 300px; cursor: move; transition: src 0.3s ease;
            display: none; 
        }

        .controls-panel {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }

        #loading-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
            color: #00ffff; font-size: 1rem; text-align: center; padding: 20px;
            line-height: 1.5;
        }

        .hair-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hair-option {
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;
            cursor: pointer; text-align: center;
        }
        .hair-option img { width: 100%; height: 50px; object-fit: contain; }

        @media (max-width: 768px) {
            #main-app { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
            .controls-panel { max-height: 250px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="brand-title">æ™“æ—æŠ€æœ¯</h1>
        <div class="login-box">
            <p>DESIGN STUDIO</p>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            <br>
            <button onclick="checkPassword()">è¿›å…¥ç³»ç»Ÿ</button>
            <p id="login-error" style="color:#ff3366; font-size:12px; margin-top:10px; display:none;">å¯†ç é”™è¯¯</p>
        </div>
    </div>

    <div id="main-app">
        <div class="camera-section">
            <div id="loading-mask">
                <div style="font-size:30px; margin-bottom:10px;">â˜ï¸</div>
                <div id="loading-text">æ­£åœ¨è¿æ¥...</div>
            </div>
            <video id="video" autoplay playsinline></video>
            <img id="hair-overlay" crossorigin="anonymous" src="">
        </div>

        <div class="controls-panel">
            <h2 style="margin:0; border-bottom:1px solid #555; padding-bottom:10px;">æ§åˆ¶å°-æ™“æ—æŠ€æœ¯</h2>
            <button onclick="clearHair()" style="background:#555; margin-top:0;">âŒ æ¸…é™¤å‘å‹</button>
            
            <h3>é€‰æ‹©å‘å‹</h3>
            <div class="hair-grid">
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408201.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/9408/9408201.png"><br>çŸ­å‘
                </div>
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408197.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/9408/9408197.png"><br>é•¿å·
                </div>
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408192.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/9408/9408192.png"><br>ç‹¼å°¾
                </div>
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/4140/4140048.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png"><br>å¡é€š
                </div>
            </div>

            <h3>å¾®è°ƒ</h3>
            <input type="range" min="100" max="600" value="300" style="width:100%" oninput="document.getElementById('hair-overlay').style.width = this.value + 'px'">
            <button onclick="snapshot()" style="background: #00cc66; font-size: 1.1rem; margin-top:auto;">ğŸ“¸ æ‹ç…§å¹¶ä¿å­˜</button>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const CONFIG = {
            loginPassword: "123",       // ç½‘ç«™è¿›å…¥å¯†ç 
            uploadUrl: "https://image.hanglinkj.com/upload",
            uploadToken: "188"          // å¯¹åº”ä½ æˆªå›¾é‡Œçš„ AUTH_CODE å€¼
        };

        // ================= é€»è¾‘åŒº =================
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === CONFIG.loginPassword) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'grid';
                startCamera();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿ä½¿ç”¨HTTPSæˆ–å…è®¸æƒé™ã€‚");
            }
        }

        function changeHair(src) {
            const overlay = document.getElementById('hair-overlay');
            overlay.src = src;
            overlay.style.display = 'block';
        }

        function clearHair() {
            document.getElementById('hair-overlay').style.display = 'none';
        }

        async function snapshot() {
            const video = document.getElementById('video');
            const overlay = document.getElementById('hair-overlay');
            const loading = document.getElementById('loading-mask');
            const logText = document.getElementById('loading-text');

            loading.style.display = 'flex';
            logText.innerText = "ç”Ÿæˆå›¾ç‰‡ä¸­...";

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');

            // 1. ç”ŸæˆåŸå›¾ Blob
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            const originalBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));

            // 2. ç”Ÿæˆè®¾è®¡å›¾ Blob
            let designBlob = null;
            if (overlay.style.display !== 'none') {
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                const size = parseInt(overlay.style.width || 300);
                const x = (canvas.width - size) / 2;
                const y = (canvas.height * 0.2);
                try { ctx.drawImage(overlay, x, y, size, size); } catch(e){}
                designBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
            }

            // 3. ä¸Šä¼ æµç¨‹
            logText.innerHTML = "æ­£åœ¨è¿æ¥å›¾åºŠ...<br>è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ";
            
            try {
                const res1 = await uploadSimple(originalBlob, 'original');
                let res2 = "æœªé€‰æ‹©å‘å‹";
                if (designBlob) {
                    res2 = await uploadSimple(designBlob, 'design');
                }
                
                alert(`âœ… æˆåŠŸï¼\nåŸå›¾: ${res1}\nè®¾è®¡å›¾: ${res2}`);
            } catch (err) {
                alert("âŒ ä¸Šä¼ å¤±è´¥: \n" + err.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šçº¯å‡€ç‰ˆä¸Šä¼ å‡½æ•°ï¼ˆé˜²æ­¢ Failed to fetchï¼‰ ---
        async function uploadSimple(blob, type) {
            const formData = new FormData();
            formData.append('file', blob, `xiaolin_${type}_${Date.now()}.jpg`);
            
            // ä¸ºäº†å…¼å®¹ï¼ŒformDataé‡Œä¹Ÿæ”¾ä¸€ä»½
            formData.append('authCode', CONFIG.uploadToken); 

            // ã€å…³é”®ã€‘åªä½¿ç”¨ URL å‚æ•°ä¼ é€’ authCode
            // è¿™æ ·ä¸ä¼šè§¦å‘ CORS é¢„æ£€ï¼ˆOptionsè¯·æ±‚ï¼‰ï¼Œè§£å†³ Failed to fetch é—®é¢˜
            const targetUrl = `${CONFIG.uploadUrl}?authCode=${CONFIG.uploadToken}`;

            const response = await fetch(targetUrl, {
                method: 'POST',
                body: formData
                // æ³¨æ„ï¼šè¿™é‡Œä¸è¦åŠ ä»»ä½• headersï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†
            });

            const text = await response.text();
            
            let json;
            try {
                json = JSON.parse(text);
            } catch (e) {
                throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${text.substring(0, 100)}`);
            }

            // è§£æä¸åŒçš„è¿”å›æ ¼å¼
            const imgUrl = json.src || json.url || (json.data && json.data.url) || (json[0] && json[0].src);
            
            if (imgUrl) {
                return imgUrl.startsWith('http') ? imgUrl : 'https://image.hanglinkj.com' + imgUrl;
            } else {
                throw new Error(json.msg || json.error || "æœªè¿”å›é“¾æ¥");
            }
        }
    </script>
</body>
</html>