<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>坐姿监督 - 设置</title>
  <link rel="stylesheet" href="./assets/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <span>坐姿监督</span>
        <span class="badge">晓林技术支持</span>
      </div>
      <nav class="nav">
        <a href="./monitor.html">监控</a>
        <a class="active" href="./settings.html">设置</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="card-h">
        <div>
          <div style="font-weight:700">学习计划与提醒</div>
          <div class="help">这些设置会保存到本机浏览器（localStorage）。</div>
        </div>
        <div class="btn-row">
          <button id="btnSave" class="primary">保存</button>
          <button id="btnReset">恢复默认</button>
        </div>
      </div>
      <div class="card-b">
        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div class="card" style="border-radius:14px">
            <div class="card-b">
              <label for="sessionMinutes">学习时长（分钟）</label>
              <input id="sessionMinutes" type="number" min="5" max="180" step="1" />

              <label for="breakMinutes">休息时长（分钟）</label>
              <input id="breakMinutes" type="number" min="1" max="60" step="1" />

              <label for="warningCooldownSec">语音提醒冷却（秒）</label>
              <input id="warningCooldownSec" type="number" min="2" max="60" step="1" />

              <hr class="sep" />

              <div style="font-weight:700">坐姿识别精度/校准</div>
              <div class="help">不同手机摆放距离不同，建议先用默认值，如果误报/漏报再调。</div>

              <label for="postureSensitivity">识别敏感度（0.6 - 1.6）</label>
              <input id="postureSensitivity" type="number" min="0.6" max="1.6" step="0.05" />

              <label for="shoulderWidthRef">距离基准（肩宽比例，0=默认）</label>
              <input id="shoulderWidthRef" type="number" min="0" max="1" step="0.001" />
              <div class="help">说明：这是画面里“肩到肩”的相对宽度。想更准可在“坐姿良好”时记下一个值填这里。</div>

              <label for="nearTargetRatio">太近判定（0.60 - 1.20，越大越严格）</label>
              <input id="nearTargetRatio" type="number" min="0.60" max="1.20" step="0.01" />

              <label for="nearTolerance">太近容忍度（0.06 - 0.50，越小越严格）</label>
              <input id="nearTolerance" type="number" min="0.06" max="0.50" step="0.01" />

              <hr class="sep" />

              <div class="kv">
                <div>
                  <div style="font-weight:700">语音播报</div>
                  <small>需要浏览器支持 SpeechSynthesis（多数安卓支持）。</small>
                </div>
                <select id="ttsEnabled">
                  <option value="true">开启</option>
                  <option value="false">关闭</option>
                </select>
              </div>

              <label for="voiceMode">语音模式（解决微信没声音）</label>
              <select id="voiceMode">
                <option value="auto">自动（微信优先语音包）</option>
                <option value="audio">仅语音包（最稳）</option>
                <option value="tts">仅浏览器 TTS（电脑更稳）</option>
              </select>

              <div class="notice" style="margin-top:10px">
                建议：在微信里选择“仅语音包”，并上传一个女声 mp3 作为提醒音。
              </div>

              <hr class="sep" />

              <div style="font-weight:700">语音包（mp3 / m4a）</div>
              <div class="help">已支持“项目内置语音包”（放到 assets/audio/warn.mp3 与 break.mp3）。下面上传是可选的覆盖方案。</div>

              <label for="audioWarnFile">警告提示音（女声）</label>
              <input id="audioWarnFile" type="file" accept="audio/*" />
              <div class="btn-row" style="margin-top:10px">
                <button id="btnTestWarn">测试警告音</button>
                <button id="btnDelWarn">删除警告音</button>
              </div>

              <label for="audioBreakFile">休息提示音（女声）</label>
              <input id="audioBreakFile" type="file" accept="audio/*" />
              <div class="btn-row" style="margin-top:10px">
                <button id="btnTestBreak">测试休息音</button>
                <button id="btnDelBreak">删除休息音</button>
              </div>

              <label for="preferFemale">优先女声</label>
              <select id="preferFemale">
                <option value="true">是</option>
                <option value="false">否</option>
              </select>

              <label for="ttsRate">语速（0.7 - 1.3）</label>
              <input id="ttsRate" type="number" min="0.7" max="1.3" step="0.01" />

              <label for="ttsPitch">音调（0.8 - 1.8）</label>
              <input id="ttsPitch" type="number" min="0.8" max="1.8" step="0.01" />

              <label for="ttsVolume">音量（0 - 1）</label>
              <input id="ttsVolume" type="number" min="0" max="1" step="0.05" />

              <div style="margin-top:10px" class="btn-row">
                <button id="btnTestVoice">测试语音</button>
              </div>
            </div>
          </div>

          <div class="card" style="border-radius:14px">
            <div class="card-b">
              <div style="font-weight:700">警告语库（每行一句）</div>
              <div class="help">后续我会做“轻微/中等/严重”分级并随机选择，让提醒更自然。</div>
              <label for="warningLines">警告语</label>
              <textarea id="warningLines"></textarea>
              <div class="help">建议包含：坐直、眼距、肩颈放松、双脚着地、不要趴写等。</div>
            </div>
          </div>

          <div class="card" style="border-radius:14px">
            <div class="card-b">
              <div style="font-weight:700">使用前必读</div>
              <div class="help">
                <div>1) 摄像头权限：首次会弹窗，请选择允许。</div>
                <div>2) 必须是 HTTPS：线上部署请使用 https 域名，否则手机无法打开摄像头。</div>
                <div>3) 微信内置浏览器：部分机型需要点击一次按钮后才能语音播报。</div>
              </div>
              <hr class="sep" />
              <div class="notice">
                重要：这是“辅助监督/提醒”工具，晓林技术不替代家长看护；也不要把它当作医疗建议,只是临时给小孩子的一个辅导动作。
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="./assets/app.js"></script>
  <script>
    const els = {
      sessionMinutes: document.getElementById('sessionMinutes'),
      breakMinutes: document.getElementById('breakMinutes'),
      warningCooldownSec: document.getElementById('warningCooldownSec'),
      postureSensitivity: document.getElementById('postureSensitivity'),
      shoulderWidthRef: document.getElementById('shoulderWidthRef'),
      nearTargetRatio: document.getElementById('nearTargetRatio'),
      nearTolerance: document.getElementById('nearTolerance'),
      ttsEnabled: document.getElementById('ttsEnabled'),
      voiceMode: document.getElementById('voiceMode'),
      preferFemale: document.getElementById('preferFemale'),
      ttsRate: document.getElementById('ttsRate'),
      ttsPitch: document.getElementById('ttsPitch'),
      ttsVolume: document.getElementById('ttsVolume'),
      warningLines: document.getElementById('warningLines'),
      btnSave: document.getElementById('btnSave'),
      btnReset: document.getElementById('btnReset'),
      btnTestVoice: document.getElementById('btnTestVoice'),
      audioWarnFile: document.getElementById('audioWarnFile'),
      audioBreakFile: document.getElementById('audioBreakFile'),
      btnTestWarn: document.getElementById('btnTestWarn'),
      btnDelWarn: document.getElementById('btnDelWarn'),
      btnTestBreak: document.getElementById('btnTestBreak'),
      btnDelBreak: document.getElementById('btnDelBreak')
    };

    function fillForm(s){
      els.sessionMinutes.value = s.sessionMinutes;
      els.breakMinutes.value = s.breakMinutes;
      els.warningCooldownSec.value = s.warningCooldownSec;
      els.postureSensitivity.value = s.postureSensitivity;
      els.shoulderWidthRef.value = s.shoulderWidthRef;
      els.nearTargetRatio.value = s.nearTargetRatio;
      els.nearTolerance.value = s.nearTolerance;
      els.ttsEnabled.value = String(!!s.ttsEnabled);
      els.voiceMode.value = String(s.voiceMode || 'auto');
      els.preferFemale.value = String(!!s.preferFemale);
      els.ttsRate.value = s.ttsRate;
      els.ttsPitch.value = s.ttsPitch;
      els.ttsVolume.value = s.ttsVolume;
      els.warningLines.value = s.warningLines;
    }

    function readForm(){
      return {
        sessionMinutes: Number(els.sessionMinutes.value || 45),
        breakMinutes: Number(els.breakMinutes.value || 10),
        warningCooldownSec: Number(els.warningCooldownSec.value || 6),
        postureSensitivity: Number(els.postureSensitivity.value || 1.0),
        shoulderWidthRef: Number(els.shoulderWidthRef.value || 0),
        nearTargetRatio: Number(els.nearTargetRatio.value || 0.90),
        nearTolerance: Number(els.nearTolerance.value || 0.18),
        ttsEnabled: els.ttsEnabled.value === 'true',
        voiceMode: String(els.voiceMode.value || 'auto'),
        preferFemale: els.preferFemale.value === 'true',
        ttsRate: Number(els.ttsRate.value || 1.0),
        ttsPitch: Number(els.ttsPitch.value || 1.2),
        ttsVolume: Number(els.ttsVolume.value || 1.0),
        warningLines: String(els.warningLines.value || '').trim()
      };
    }

    els.audioWarnFile.addEventListener('change', async () => {
      const f = els.audioWarnFile.files && els.audioWarnFile.files[0];
      if(!f) return;
      const s = readForm();
      await window.PG.unlockAudio();
      await window.PG.saveAudioClip(String(s.audioWarnKey || 'warn_female'), f);
      window.PG.speak('警告语音已保存。', s);
      els.audioWarnFile.value = '';
    });

    els.audioBreakFile.addEventListener('change', async () => {
      const f = els.audioBreakFile.files && els.audioBreakFile.files[0];
      if(!f) return;
      const s = readForm();
      await window.PG.unlockAudio();
      await window.PG.saveAudioClip(String(s.audioBreakKey || 'break_female'), f);
      window.PG.speak('休息语音已保存。', s);
      els.audioBreakFile.value = '';
    });

    els.btnTestWarn.addEventListener('click', async () => {
      const s = readForm();
      await window.PG.unlockAudio();
      try{
        const ok = await (async () => {
          const f = await window.PG.getAudioClip(String(s.audioWarnKey || 'warn_female'));
          if(!f) return false;
          const url = URL.createObjectURL(f);
          try{
            const a = new Audio(url);
            a.playsInline = true;
            await a.play();
            return true;
          }finally{
            setTimeout(() => URL.revokeObjectURL(url), 1500);
          }
        })();
        if(!ok) window.PG.speak('还没有上传警告语音。', s);
      }catch(e){
        window.PG.speak('播放失败：请在微信里先点击一次按钮再试。', s);
      }
    });

    els.btnDelWarn.addEventListener('click', async () => {
      const s = readForm();
      await window.PG.deleteAudioClip(String(s.audioWarnKey || 'warn_female'));
      window.PG.speak('警告语音已删除。', s);
    });

    els.btnTestBreak.addEventListener('click', async () => {
      const s = readForm();
      await window.PG.unlockAudio();
      try{
        const f = await window.PG.getAudioClip(String(s.audioBreakKey || 'break_female'));
        if(!f){
          window.PG.speak('还没有上传休息语音。', s);
          return;
        }
        const url = URL.createObjectURL(f);
        try{
          const a = new Audio(url);
          a.playsInline = true;
          await a.play();
        }finally{
          setTimeout(() => URL.revokeObjectURL(url), 1500);
        }
      }catch(e){
        window.PG.speak('播放失败：请在微信里先点击一次按钮再试。', s);
      }
    });

    els.btnDelBreak.addEventListener('click', async () => {
      const s = readForm();
      await window.PG.deleteAudioClip(String(s.audioBreakKey || 'break_female'));
      window.PG.speak('休息语音已删除。', s);
    });

    els.btnSave.addEventListener('click', () => {
      const s = readForm();
      window.PG.saveSettings(s);
      window.PG.speak('设置已保存。', s);
      els.btnSave.textContent = '已保存';
      setTimeout(() => els.btnSave.textContent = '保存', 900);
    });

    els.btnReset.addEventListener('click', () => {
      window.PG.saveSettings(window.PG.DEFAULTS);
      fillForm(window.PG.DEFAULTS);
      window.PG.speak('已恢复默认设置。', window.PG.DEFAULTS);
    });

    els.btnTestVoice.addEventListener('click', () => {
      const s = readForm();
      window.PG.speak('小朋友，坐直一点哦。背挺直，肩膀放松，眼睛离书一拳。', s);
    });

    fillForm(window.PG.loadSettings());
  </script>
</body>
</html>
