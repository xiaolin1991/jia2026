<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™“æ—æŠ€æœ¯ - æ™ºèƒ½å‘å‹è®¾è®¡å®¤</title>
    <style>
        :root {
            --primary-color: #ff00cc;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --blur: 15px;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1a0b2e 0%, #4a195b 50%, #16245a 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ç‚«å½©æ ‡é¢˜ */
        .brand-title {
            font-size: 2.5rem; font-weight: 900; text-align: center;
            background: linear-gradient(90deg, #ff00cc, #333399, #00ffff, #ff00cc);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* ç™»å½•æ¡† */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(20px);
        }
        .login-box {
            background: var(--glass-bg); padding: 40px; border-radius: 20px;
            border: var(--glass-border); text-align: center;
        }
        input { padding: 10px; border-radius: 8px; border: none; margin-top: 15px; width: 200px; text-align:center;}
        button {
            padding: 10px 20px; border-radius: 8px; border: none;
            background: linear-gradient(45deg, #ff00cc, #333399);
            color: white; font-weight: bold; cursor: pointer; margin-top: 15px;
        }

        /* ä¸»ç•Œé¢ */
        #main-app {
            display: none; width: 90%; max-width: 1200px; height: 90vh;
            background: var(--glass-bg); border-radius: 25px; border: var(--glass-border);
            padding: 20px; box-sizing: border-box;
            grid-template-columns: 1fr 300px; gap: 20px;
        }

        .camera-section {
            position: relative; background: #000; border-radius: 15px;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        #hair-overlay {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 300px; cursor: move; transition: src 0.3s ease;
        }

        .controls-panel {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }

        /* åŠ è½½é®ç½© */
        #loading-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
            color: #00ffff; font-size: 1.2rem;
        }

        /* å‘å‹é€‰æ‹© */
        .hair-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hair-option {
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;
            cursor: pointer; text-align: center;
        }
        .hair-option img { width: 100%; height: 50px; object-fit: contain; }
        .hair-option:hover { background: rgba(255,255,255,0.3); }

        @media (max-width: 768px) {
            #main-app { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
            .controls-panel { max-height: 250px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="brand-title">æ™“æ—æŠ€æœ¯</h1>
        <div class="login-box">
            <p>DESIGN STUDIO</p>
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            <br>
            <button onclick="checkPassword()">è¿›å…¥ç³»ç»Ÿ</button>
            <p id="login-error" style="color:#ff3366; font-size:12px; margin-top:10px; display:none;">å¯†ç é”™è¯¯</p>
        </div>
    </div>

    <div id="main-app">
        <div class="camera-section">
            <div id="loading-mask">
                <div style="font-size:30px; margin-bottom:10px;">â˜ï¸</div>
                <div id="loading-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
            </div>
            <video id="video" autoplay playsinline></video>
            <img id="hair-overlay" crossorigin="anonymous" src="https://cdn-icons-png.flaticon.com/512/9408/9408201.png">
        </div>

        <div class="controls-panel">
            <h2 style="margin:0; border-bottom:1px solid #555; padding-bottom:10px;">æ§åˆ¶å°</h2>
            
            <button onclick="autoMatch()" style="background:#333399;">ğŸ¤– AI æ™ºèƒ½åŒ¹é…</button>
            
            <h3>é€‰æ‹©å‘å‹</h3>
            <div class="hair-grid">
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408201.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/9408/9408201.png"><br>çŸ­å‘
                </div>
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408197.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/9408/9408197.png"><br>é•¿å·
                </div>
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408192.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/9408/9408192.png"><br>ç‹¼å°¾
                </div>
                <div class="hair-option" onclick="changeHair('https://cdn-icons-png.flaticon.com/512/12349/12349764.png')">
                    <img src="https://cdn-icons-png.flaticon.com/512/12349/12349764.png"><br>èƒŒå¤´
                </div>
            </div>

            <h3>å¾®è°ƒ</h3>
            <label>å¤§å°</label>
            <input type="range" min="100" max="600" value="300" style="width:100%" oninput="document.getElementById('hair-overlay').style.width = this.value + 'px'">
            
            <button onclick="snapshot()" style="background: #00cc66; font-size: 1.1rem; margin-top:auto;">ğŸ“¸ æ‹ç…§å¹¶ä¿å­˜</button>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const CONFIG = {
            loginPassword: "123",  // ç½‘ç«™è¿›å…¥å¯†ç  (ä½ è‡ªå·±å®š)
            
            // ä½ çš„å›¾åºŠé…ç½®
            uploadUrl: "https://image.hanglinkj.com/upload",
            uploadToken: "188"     // ä½ æä¾›çš„å›¾åºŠå¯†ç /Token
        };

        // ================= åŠŸèƒ½é€»è¾‘ =================

        // 1. ç™»å½•éªŒè¯
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            // å¼€å…³ç½‘ç«™å¯†ç ï¼ˆè¿™é‡Œè®¾ä¸ºé»˜è®¤å¼€å¯ï¼‰
            if (true) { 
                if (input === CONFIG.loginPassword) {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'grid';
                    startCamera();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            }
        }

        // 2. å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ï¼Œæˆ–è€…ä½¿ç”¨HTTPSè®¿é—®ã€‚");
            }
        }

        // 3. åˆ‡æ¢å‘å‹
        function changeHair(src) {
            document.getElementById('hair-overlay').src = src;
        }

        // 4. æ ¸å¿ƒåŠŸèƒ½ï¼šåŒé‡æ‹ç…§ä¸Šä¼ 
        async function snapshot() {
            const video = document.getElementById('video');
            const overlay = document.getElementById('hair-overlay');
            const loading = document.getElementById('loading-mask');
            const logText = document.getElementById('loading-text');

            loading.style.display = 'flex';
            logText.innerText = "æ­£åœ¨å¤„ç†å›¾ç‰‡...";

            // åˆ›å»ºç”»å¸ƒ
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');

            // --- A. å‡†å¤‡åŸå›¾ (åªç”»è§†é¢‘) ---
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®
            
            // è·å–åŸå›¾Blob
            const originalBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));

            // --- B. å‡†å¤‡è®¾è®¡å›¾ (ç”»è§†é¢‘ + å‘å‹) ---
            // é‡æ–°ç»˜åˆ¶åº•å›¾ï¼ˆç¡®ä¿å¹²å‡€ï¼‰
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // ç»˜åˆ¶å‘å‹
            const size = parseInt(overlay.style.width || 300);
            const x = (canvas.width - size) / 2;
            const y = (canvas.height * 0.2); // å‡è®¾å‘å‹åœ¨ä¸Šæ–¹20%ä½ç½®
            try {
                ctx.drawImage(overlay, x, y, size, size);
            } catch(e) { console.log("è·¨åŸŸé—®é¢˜ï¼Œå‘å‹å¯èƒ½æœªç»˜åˆ¶"); }

            // è·å–è®¾è®¡å›¾Blob
            const designBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));

            // --- C. å¼€å§‹ä¸Šä¼  ---
            logText.innerText = "æ­£åœ¨ä¸Šä¼ åˆ° image.hanglinkj.com ...";

            try {
                // å¹¶è¡Œä¸Šä¼ ä¸¤å¼ å›¾
                const [res1, res2] = await Promise.all([
                    uploadToCloudflare(originalBlob, 'original'),
                    uploadToCloudflare(designBlob, 'design')
                ]);

                alert(`âœ… å¤„ç†æˆåŠŸï¼\n\n1. åŸå›¾å·²ä¿å­˜: ${res1}\n2. è®¾è®¡å›¾å·²ä¿å­˜: ${res2}`);
                console.log("åŸå›¾:", res1);
                console.log("è®¾è®¡å›¾:", res2);

            } catch (error) {
                alert("âŒ ä¸Šä¼ å¤±è´¥: " + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // é€šç”¨ä¸Šä¼ å‡½æ•°
        async function uploadToCloudflare(blob, type) {
            const formData = new FormData();
            // æ–‡ä»¶ååŠ ä¸Šæ—¶é—´æˆ³å’Œç±»å‹
            const filename = `xiaolin_${type}_${Date.now()}.jpg`;
            formData.append('file', blob, filename);
            
            // æ·»åŠ å¯†ç /Token (å…³é”®æ­¥éª¤)
            if (CONFIG.uploadToken) {
                formData.append('token', CONFIG.uploadToken);
            }

            const response = await fetch(CONFIG.uploadUrl, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            // è§£æè¿”å›çš„é“¾æ¥
            const imgUrl = result.src || result.url || (result.data && result.data.url);
            
            if (imgUrl) {
                // å¦‚æœè¿”å›çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥å®Œæ•´åŸŸå
                return imgUrl.startsWith('http') ? imgUrl : 'https://image.hanglinkj.com' + imgUrl;
            } else {
                throw new Error("å›¾åºŠæœªè¿”å›é“¾æ¥");
            }
        }

        // 5. æ¨¡æ‹ŸAIåŒ¹é…
        function autoMatch() {
            alert("ç³»ç»Ÿæ­£åœ¨åˆ†ææ‚¨çš„è„¸å‹... (æ¼”ç¤ºï¼šå·²ä¸ºæ‚¨æ¨èå‘å‹)");
            changeHair('https://cdn-icons-png.flaticon.com/512/9408/9408197.png');
        }
    </script>
</body>
</html>